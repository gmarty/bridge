var $jscomp={scope:{},getGlobal:function(h){return"undefined"!=typeof window&&window===h?h:"undefined"!=typeof global?global:h}};$jscomp.global=$jscomp.getGlobal(this);$jscomp.patches={};$jscomp.patch=function(h,d){($jscomp.patches[h]=$jscomp.patches[h]||[]).push(d);var g=$jscomp.global;h=h.split(".");for(var k=0;k<h.length-1&&g;k++)g=g[h[k]];h=h[h.length-1];g&&g[h]instanceof Function&&(g[h]=d(g[h]))};$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};if(!$jscomp.global.Symbol){$jscomp.global.Symbol=$jscomp.Symbol;var h=[],d=function(d){return function(k){h=[];k=d(k);for(var e=[],l=0,n=k.length;l<n;l++){var c;a:if(c=k[l],c.length<$jscomp.SYMBOL_PREFIX.length)c=!1;else{for(var q=0;q<$jscomp.SYMBOL_PREFIX.length;q++)if(c[q]!=$jscomp.SYMBOL_PREFIX[q]){c=!1;break a}c=!0}c?h.push(k[l]):e.push(k[l])}return e}};$jscomp.patch("Object.keys",d);$jscomp.patch("Object.getOwnPropertyNames",d);$jscomp.patch("Object.getOwnPropertySymbols",
function(g){return function(k){d.unused=Object.getOwnPropertyNames(k);h.push.apply(g(k));return h}})}};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(h){return $jscomp.SYMBOL_PREFIX+h+$jscomp.symbolCounter_++};$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();$jscomp.global.Symbol.iterator||($jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));$jscomp.initSymbolIterator=function(){}};
$jscomp.makeIterator=function(h){$jscomp.initSymbolIterator();var d=h[Symbol.iterator];if(d)return d.call(h);var g=0;return{next:function(){return g<h.length?{done:!1,value:h[g++]}:{done:!0}}}};$jscomp.arrayFromIterator=function(h){for(var d,g=[];!(d=h.next()).done;)g.push(d.value);return g};$jscomp.arrayFromIterable=function(h){return h instanceof Array?h:$jscomp.arrayFromIterator($jscomp.makeIterator(h))};
(function(h){"object"===typeof exports&&"undefined"!==typeof module?module.exports=h():"function"===typeof define&&define.amd?define([],h):("undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:this).bridge=h()})(function(){return function d(g,k,e){function l(c,p){if(!k[c]){if(!g[c]){var m="function"==typeof require&&require;if(!p&&m)return m(c,!0);if(n)return n(c,!0);p=Error("Cannot find module '"+c+"'");throw p.code="MODULE_NOT_FOUND",p;}p=k[c]={exports:{}};
g[c][0].call(p.exports,function(b){var a=g[c][1][b];return l(a?a:b)},p,p.exports,d,g,k,e)}return k[c].exports}for(var n="function"==typeof require&&require,c=0;c<e.length;c++)l(e[c]);return l}({1:[function(d,g,k){g=g.exports=self.bridge||{};g.client=d("../src/client");self.bridge=g},{"../src/client":2}],2:[function(d,g,k){function e(a,r,b){if(!(this instanceof e))return new e(a,r,b);"object"==typeof a&&(r=a.endpoint,b=a.timeout,a=a.service);this.id=p();this.service=a;this.timeout=b;this.endpoint=
r||this.endpoint;if(!this.endpoint)throw l(1);this.setPort(this.endpoint);this.pending=new Set;this.receiver=q.receiver(this.id).on("_push",this.onPush.bind(this));m("initialized",a)}function l(a,b){for(var f=[],c=1;c<arguments.length;++c)f[c-1]=arguments[c];return Error({1:"an endpoint must be defined",2:'Unable to establish a connection with "'+f[0]+'". Either the target endpoint is not alive or the Service is not `.listen()`ing.',3:'Method "'+f[0]+"\" didn't get a response. Either the target endpoint is not alive or the Service is not `.listen()`ing."}[a])}
var n=d("./message/port-adaptors"),c=d("./emitter"),q=d("./message"),p=d("./utils").uuid;g.exports=e;var m={0:function(){},1:function(a){return performance.mark("["+self.constructor.name+"][Client] - "+a)},2:function(a,b){for(var f=[],c=1;c<arguments.length;++c)f[c-1]=arguments[c];console.log.apply(console,[].concat(["[Client]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+a+'"'],$jscomp.arrayFromIterable(f)))}}[0],b=self.constructor.name;e.prototype={connect:function(){var a=this;
m("connect");if(this.connected)return this.connected;m("connecting...",this.service);var r=new MessageChannel;this.channel=r.port1;this.channel.start();var f={clientId:this.id,service:this.service,originEnv:b};return this.connected=this.message("_connect").set("transfer",[r.port2]).set("data",f).listen(r.port1).send().then(function(b){m("connected",b);b.event.target===a.channel?a.setPort(a.channel):(a.channel.close(),delete a.channel);a.receiver.listen(a.port)}).catch(function(b){"timeout"==(b&&b.message)&&
(b=l(2,a.service),console.error(b.message));throw b;})},disconnect:function(a){var b=this;if(!this.connected)return Promise.resolve();m("disconnecting ...");a={noRespond:a&&a.noRespond,data:this.id};this.cancelPending();return this.message("_disconnect").set(a).send().then(function(){return b.onDisconnected()})},method:function(a,b){for(var f=[],c=1;c<arguments.length;++c)f[c-1]=arguments[c];var d=this;return this.connect().then(function(){m("method",a);return d.message("_method").set({recipient:d.service,
data:{name:a,args:f}}).send()}).then(function(a){return a.value}).catch(function(b){"timeout"==(b&&b.message)&&(b=l(3,a),console.error(b.message));throw b;})},plugin:function(a){a(this,{Emitter:c,uuid:p});return this},message:function(a){var b=this;m("create message",a);var f=q(a).set("port",this.port).set("timeout",this.timeout).on("response",function(){return b.pending.delete(f)}).on("cancel",function(){return b.pending.delete(f)});this.pending.add(f);return f},cancelPending:function(){m("cancel pending");
this.pending.forEach(function(a){a.cancel()});this.pending.clear()},pendingResponded:function(){var a=[];this.pending.forEach(function(b){return a.push(b.responded)});return Promise.all(a)},onPush:function(a){m("on push",a.data);this._emit(a.data.type,a.data.data)},onDisconnected:function(){var a=this;delete this.connected;this.pendingResponded().then(function(){m("disconnected");a.channel&&a.channel.close();a._emit("disconnected")})},setPort:function(a){m("set port");this.port=n(a)},destroy:function(){var a=
this;return this.disconnect().then(function(){a.destroyed||(m("destroy"),a.destroyed=!0,a.receiver.destroy(),a._off(),a.port=a.endpoint=a.receiver=null)})},_on:c.prototype.on,_off:c.prototype.off,_emit:c.prototype.emit};e.prototype.on=function(a,b){var f=this;this.connect().then(function(){m("bind on",a);c.prototype.on.call(f,a,b);f.message("_on").set("noRespond",!0).set("data",{name:a,clientId:f.id}).send(f.port)});return this};e.prototype.off=function(a,b){var f=this;this.connect().then(function(){c.prototype.off.call(f,
a,b);f.message("_off").set("noRespond",!0).set("data",{name:a,clientId:f.id}).send(f.port)});return this}},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":6}],3:[function(d,g,k){function e(d){if(d)return Object.assign(d,e.prototype)}g.exports=e;e.prototype={on:function(d,e){this._callbacks||(this._callbacks={});this._callbacks[d]||(this._callbacks[d]=[]);this._callbacks[d].push(e);return this},off:function(d,e){if(this._callbacks)switch(arguments.length){case 0:this._callbacks=
{};break;case 1:delete this._callbacks[d];break;default:var c=this._callbacks[d];if(!c)return;var g=c.indexOf(e);~g&&c.splice(g,1)}return this},emit:function(d,e){if(this._callbacks)for(var c=this._callbacks[d]||[],c=c.concat(this._callbacks["*"]||[]),g=0;g<c.length;g++)c[g].call(this,e,d);return this}};d=e.prototype;d.off=d.off;d.on=d.on},{}],4:[function(d,g,k){function e(a){this.cancelled=!1;this.listeners=[];this.deferred=p();this.listen=this.listen.bind(this);this.onMessage=this.onMessage.bind(this);
this.onTimeout=this.onTimeout.bind(this);"object"===typeof a?this.setupInbound(a):this.setupOutbound(a);b("initialized",this.type)}function l(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this);b("receiver initialized",a)}function n(a,b){for(var f=1;f<arguments.length;++f);return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}
var c=d("./port-adaptors"),q=d("../emitter");d=d("../utils");var p=d.deferred,m=d.uuid;k=g.exports=function(a){return new e(a)};k.receiver=function(a,b){return new l(a,b)};k.Receiver=l;k.Message=e;var b={0:function(){},1:function(a){return performance.mark("["+self.constructor.name+"][Message] - "+a)},2:function(a,b){for(var f=[],c=1;c<arguments.length;++c)f[c-1]=arguments[c];console.log.apply(console,[].concat(["[Message]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+a+'"'],$jscomp.arrayFromIterable(f)))}}[0];
e.prototype={setupOutbound:function(a){this.id=m();this.type=a;this.sent=!1;this.recipient="*"},setupInbound:function(a){b("inbound");this.hasResponded=!1;this.setSourcePort(a.source||a.target);this.event=a;Object.assign(this,a.data)},setSourcePort:function(a){b("set source",a.constructor.name);this.sourcePort=c(a,{ready:!0});return this},set:function(a,c){b("set",a,c);"object"==typeof a?Object.assign(this,a):this[a]=c;return this},serialize:function(){return{id:this.id,type:this.type,data:this.data,
recipient:this.recipient,noRespond:this.noRespond}},preventDefault:function(){b("prevent default");this.defaultPrevented=!0},send:function(a){b("send",this.type);if(this.sent)throw n(1);var d=this.serialize(),f=!this.noRespond;this.port=a?c(a):this.port;if(!this.port)throw n(3);f?(this.listen(this.port),this.setResponseTimeout()):this.deferred.resolve();this.port.postMessage(d,this.getTransfer());b("sent",d);return this.deferred.promise},setResponseTimeout:function(){!1!==this.timeout&&(this._timer=
setTimeout(this.onTimeout,this.timeout||2E3))},clearResponseTimeout:function(){clearTimeout(this._timer)},getTransfer:function(){return this.transfer||this.event&&this.event.ports},onMessage:function(a){if(a.data.response&&a.data.id===this.id&&!this.cancelled)this.onResponse(a)},onTimeout:function(){b("response timeout",this.type);this.silentTimeout||this.deferred.reject(n(4));this.teardown()},listen:function(a){b("add response listener",a);a=c(a);a.addListener(this.onMessage,this.listen);this.listeners.push(a);
return this},unlisten:function(){var a=this;b("remove response listeners");this.listeners.forEach(function(b){return b.removeListener(a.onMessage)});this.listeners=[]},cancel:function(){this.teardown();this.cancelled=!0;this.emit("cancel")},teardown:function(){this.clearResponseTimeout();this.unlisten()},respond:function(a){function c(a){b("resolve",a);d({type:"resolve",value:a})}function f(a){a:switch(a&&a.constructor.name){case "DOMException":case "Error":a={message:a.message};break a;case "DOMError":a=
{message:a.message,name:a.name};break a}b("reject",a);d({type:"reject",value:a})}function d(a){e.response=a;e.sourcePort.postMessage({id:e.id,response:a},e.transfer);b("responded with:",a)}b("respond",a,this.id);if(this.hasResponded)throw n(2);if(this.sourcePort&&!this.noRespond){this.hasResponded=!0;var e=this;this.error&&f(this.error);Promise.resolve(a).then(c,f).catch(f)}},forward:function(a){var c=this;b("forward");return this.set("silentTimeout",!0).send(a).then(function(a){return c.respond(a.value)})},
onResponse:function(a){b("on response",a.data);var c=a.data.response,f="reject"==c.type?c.value:c;c.event=a;this.response=c;this.teardown();this.deferred[this.response.type](f);this.emit("response",c)}};q(e.prototype);l.prototype={listen:function(a){b("listen");a=c(a||self,{receiver:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.listen),this.ports.add(a),this},unlisten:function(){var a=this;b("unlisten");this.ports.forEach(function(b){return b.removeListener(a.onMessage)})},onMessage:function(a){if(a.data.id&&
a.data.type&&this.isRecipient(a.data.recipient)&&(b("receiver on message",a.data),a=new e(a),this.emit("message",a),!a.defaultPrevented))try{this.emit(a.type,a)}catch(c){throw a.error=c,a.respond(),c;}},isRecipient:function(a){return a==this.name||"*"==a||"*"==this.name},destroy:function(){this.unlisten();delete this.name;return this}};q(l.prototype)},{"../emitter":3,"../utils":6,"./port-adaptors":5}],5:[function(d,g,k){function e(b){this.target=b}function l(b,a,c){b.addEventListener(a,c)}function n(b,
a,c){a={data:a,source:self};c&&(a.ports=c);b.dispatchEvent(new MessageEvent("message",a))}var c=d("../utils").deferred;g.exports=function(b,a){if(!b)throw Error({1:"target is undefined"}[1]);if(b&&"undefined"!==typeof b.addListener)return b;var c=p[b.constructor.name];return c?c(b,a):new e(b,a)};var q=e.prototype={constructor:e,addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,a){this.target.postMessage(b,
a)}},p={HTMLIFrameElement:function(b){var a=m(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(c,f){a.then(function(){return n(b.contentWindow,c,f)})}}},BroadcastChannel:function(b,a){function d(){var a=c();b.postMessage("ready?");l(b,"message",function t(c){"ready"==c.data&&(b.removeEventListener("message",t),a.resolve())});return a.promise}var f=a&&a.receiver,e=a&&a.ready,e=e||f?Promise.resolve():
d();f&&(b.postMessage("ready"),l(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));return{target:b,addListener:q.addListener,removeListener:q.removeListener,postMessage:function(a,c){e.then(function(){return b.postMessage(a,c)})}}},Window:function(b,a){var c=a&&a.ready||b===parent||b===self,c=c?Promise.resolve():m(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,d){c.then(function(){return n(b,
a,d)})}}},SharedWorker:function(b){b.port.start();return new e(b.port)},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(a,c){this.onconnect=function(a){a=a.ports[0];b.push(a);a.start();c(a)};self.addEventListener("connect",this.onconnect)},removeListener:function(a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();b.removeEventListener("message",a)})}}}},m=function(){if("undefined"!=typeof window){var b=window.opener||
window.parent,a=new WeakSet;b!=self&&("loading"===document.readyState?l(window,"DOMContentLoaded",function f(){window.removeEventListener("DOMContentLoaded",f);n(b,"load")}):n(b,"load"));l(self,"message",function(b){return"load"==b.data&&a.add(b.source)});return function(b){var d=b.contentWindow||b;if(a.has(d)||d==window.parent)return Promise.resolve();var e=c();l(window,"message",function t(a){"load"==a.data&&a.source==d&&(window.removeEventListener("message",t),e.resolve())});return e.promise}}}()},
{"../utils":6}],6:[function(d,g,k){k.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var g=16*Math.random()|0;return("x"==d?g:g&3|8).toString(16)})};k.deferred=function(){var d={};d.promise=new Promise(function(g,k){d.resolve=g;d.reject=k});return d}},{}]},{},[1])(1)});
