var $jscomp={scope:{},getGlobal:function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global?global:d}};$jscomp.global=$jscomp.getGlobal(this);$jscomp.patches={};$jscomp.patch=function(d,f){($jscomp.patches[d]=$jscomp.patches[d]||[]).push(f);var h=$jscomp.global;d=d.split(".");for(var c=0;c<d.length-1&&h;c++)h=h[d[c]];d=d[d.length-1];h&&h[d]instanceof Function&&(h[d]=f(h[d]))};$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};if(!$jscomp.global.Symbol){$jscomp.global.Symbol=$jscomp.Symbol;var d=[],f=function(f){return function(c){d=[];c=f(c);for(var m=[],n=0,l=c.length;n<l;n++){var g;a:if(g=c[n],g.length<$jscomp.SYMBOL_PREFIX.length)g=!1;else{for(var b=0;b<$jscomp.SYMBOL_PREFIX.length;b++)if(g[b]!=$jscomp.SYMBOL_PREFIX[b]){g=!1;break a}g=!0}g?d.push(c[n]):m.push(c[n])}return m}};$jscomp.patch("Object.keys",f);$jscomp.patch("Object.getOwnPropertyNames",f);$jscomp.patch("Object.getOwnPropertySymbols",
function(h){return function(c){f.unused=Object.getOwnPropertyNames(c);d.push.apply(h(c));return d}})}};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(d){return $jscomp.SYMBOL_PREFIX+d+$jscomp.symbolCounter_++};$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();$jscomp.global.Symbol.iterator||($jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));$jscomp.initSymbolIterator=function(){}};
$jscomp.makeIterator=function(d){$jscomp.initSymbolIterator();var f=d[Symbol.iterator];if(f)return f.call(d);var h=0;return{next:function(){return h<d.length?{done:!1,value:d[h++]}:{done:!0}}}};$jscomp.arrayFromIterator=function(d){for(var f,h=[];!(f=d.next()).done;)h.push(f.value);return h};$jscomp.arrayFromIterable=function(d){return d instanceof Array?d:$jscomp.arrayFromIterator($jscomp.makeIterator(d))};
(function e$$0(f,h,c){function m(g,b){if(!h[g]){if(!f[g]){var k="function"==typeof require&&require;if(!b&&k)return k(g,!0);if(n)return n(g,!0);b=Error("Cannot find module '"+g+"'");throw b.code="MODULE_NOT_FOUND",b;}b=h[g]={exports:{}};f[g][0].call(b.exports,function(e){var a=f[g][1][e];return m(a?a:e)},b,b.exports,e$$0,f,h,c)}return h[g].exports}for(var n="function"==typeof require&&require,l=0;l<c.length;l++)m(c[l]);return m})({1:[function(d,f,h){var c={service:d("../src/service"),client:d("../src/client"),
_m:d("../src/message")};"u"!=(typeof define)[0]?define([],function(){return c}):self.bridge=c},{"../src/client":2,"../src/message":4,"../src/service":6}],2:[function(d,f,h){function c(a,e,p){if(!(this instanceof c))return new c(a,e,p);"object"==typeof a&&(e=a.endpoint,p=a.timeout,a=a.service);this.id=b();this.service=a;this.timeout=p;this.endpoint=e||this.endpoint;if(!this.endpoint)throw m(1);this.setPort(this.endpoint);this.pending=new Set;this.receiver=g.receiver(this.id).on("_push",this.onPush.bind(this));
k("initialized",a)}function m(a,e){for(var b=[],c=1;c<arguments.length;++c)b[c-1]=arguments[c];return Error({1:"an endpoint must be defined",2:'Unable to establish a connection with "'+b[0]+'". Either the target endpoint is not alive or the Service is not `.listen()`ing.',3:'Method "'+b[0]+"\" didn't get a response. Either the target endpoint is not alive or the Service is not `.listen()`ing."}[a])}var n=d("./message/port-adaptors"),l=d("./emitter"),g=d("./message"),b=d("./utils").uuid;f.exports=
c;var k={0:function(){},1:function(a){return performance.mark("["+self.constructor.name+"][Client] - "+a)},2:function(a,e){for(var b=[],c=1;c<arguments.length;++c)b[c-1]=arguments[c];console.log.apply(console,[].concat(["[Client]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+a+'"'],$jscomp.arrayFromIterable(b)))}}[0],e=self.constructor.name;c.prototype={connect:function(){var a=this;k("connect");if(this.connected)return this.connected;k("connecting...",this.service);var b=new MessageChannel;
this.channel=b.port1;this.channel.start();var c={clientId:this.id,service:this.service,originEnv:e};return this.connected=this.message("_connect").set("transfer",[b.port2]).set("data",c).listen(b.port1).send().then(function(e){k("connected",e);e.event.target===a.channel?a.setPort(a.channel):(a.channel.close(),delete a.channel);a.receiver.listen(a.port)}).catch(function(e){"timeout"==(e&&e.message)&&(e=m(2,a.service),console.error(e.message));throw e;})},disconnect:function(a){var e=this;if(!this.connected)return Promise.resolve();
k("disconnecting ...");a={noRespond:a&&a.noRespond,data:this.id};this.cancelPending();return this.message("_disconnect").set(a).send().then(function(){return e.onDisconnected()})},method:function(a,e){for(var b=[],c=1;c<arguments.length;++c)b[c-1]=arguments[c];var d=this;return this.connect().then(function(){k("method",a);return d.message("_method").set({recipient:d.service,data:{name:a,args:b}}).send()}).then(function(a){return a.value}).catch(function(e){"timeout"==(e&&e.message)&&(e=m(3,a),console.error(e.message));
throw e;})},plugin:function(a){a(this,{Emitter:l,uuid:b});return this},message:function(a){var e=this;k("create message",a);var b=g(a).set("port",this.port).set("timeout",this.timeout).on("response",function(){return e.pending.delete(b)}).on("cancel",function(){return e.pending.delete(b)});this.pending.add(b);return b},cancelPending:function(){k("cancel pending");this.pending.forEach(function(a){a.cancel()});this.pending.clear()},pendingResponded:function(){var a=[];this.pending.forEach(function(e){return a.push(e.responded)});
return Promise.all(a)},onPush:function(a){k("on push",a.data);this._emit(a.data.type,a.data.data)},onDisconnected:function(){var a=this;delete this.connected;this.pendingResponded().then(function(){k("disconnected");a.channel&&a.channel.close();a._emit("disconnected")})},setPort:function(a){k("set port");this.port=n(a)},destroy:function(){var a=this;return this.disconnect().then(function(){a.destroyed||(k("destroy"),a.destroyed=!0,a.receiver.destroy(),a._off(),a.port=a.endpoint=a.receiver=null)})},
_on:l.prototype.on,_off:l.prototype.off,_emit:l.prototype.emit};c.prototype.on=function(a,e){var b=this;this.connect().then(function(){k("bind on",a);l.prototype.on.call(b,a,e);b.message("_on").set("noRespond",!0).set("data",{name:a,clientId:b.id}).send(b.port)});return this};c.prototype.off=function(a,e){var b=this;this.connect().then(function(){l.prototype.off.call(b,a,e);b.message("_off").set("noRespond",!0).set("data",{name:a,clientId:b.id}).send(b.port)});return this}},{"./emitter":3,"./message":4,
"./message/port-adaptors":5,"./utils":7}],3:[function(d,f,h){function c(d){if(d)return Object.assign(d,c.prototype)}f.exports=c;c.prototype={on:function(c,d){this._callbacks||(this._callbacks={});this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].push(d);return this},off:function(c,d){if(this._callbacks)switch(arguments.length){case 0:this._callbacks={};break;case 1:delete this._callbacks[c];break;default:var f=this._callbacks[c];if(!f)return;var g=f.indexOf(d);~g&&f.splice(g,1)}return this},
emit:function(c,d){if(this._callbacks)for(var f=this._callbacks[c]||[],f=f.concat(this._callbacks["*"]||[]),g=0;g<f.length;g++)f[g].call(this,d,c);return this}};d=c.prototype;d.off=d.off;d.on=d.on},{}],4:[function(d,f,h){function c(a){this.cancelled=!1;this.listeners=[];this.deferred=b();this.listen=this.listen.bind(this);this.onMessage=this.onMessage.bind(this);this.onTimeout=this.onTimeout.bind(this);"object"===typeof a?this.setupInbound(a):this.setupOutbound(a);e("initialized",this.type)}function m(a){this.name=
a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this);e("receiver initialized",a)}function n(a,e){for(var b=1;b<arguments.length;++b);return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var l=d("./port-adaptors"),g=d("../emitter");d=d("../utils");var b=d.deferred,k=d.uuid;h=f.exports=function(a){return new c(a)};h.receiver=function(a,
e){return new m(a,e)};h.Receiver=m;h.Message=c;var e={0:function(){},1:function(a){return performance.mark("["+self.constructor.name+"][Message] - "+a)},2:function(a,e){for(var b=[],c=1;c<arguments.length;++c)b[c-1]=arguments[c];console.log.apply(console,[].concat(["[Message]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+a+'"'],$jscomp.arrayFromIterable(b)))}}[0];c.prototype={setupOutbound:function(a){this.id=k();this.type=a;this.sent=!1;this.recipient="*"},setupInbound:function(a){e("inbound");
this.hasResponded=!1;this.setSourcePort(a.source||a.target);this.event=a;Object.assign(this,a.data)},setSourcePort:function(a){e("set source",a.constructor.name);this.sourcePort=l(a,{ready:!0});return this},set:function(a,b){e("set",a,b);"object"==typeof a?Object.assign(this,a):this[a]=b;return this},serialize:function(){return{id:this.id,type:this.type,data:this.data,recipient:this.recipient,noRespond:this.noRespond}},preventDefault:function(){e("prevent default");this.defaultPrevented=!0},send:function(a){e("send",
this.type);if(this.sent)throw n(1);var b=this.serialize(),c=!this.noRespond;this.port=a?l(a):this.port;if(!this.port)throw n(3);c?(this.listen(this.port),this.setResponseTimeout()):this.deferred.resolve();this.port.postMessage(b,this.getTransfer());e("sent",b);return this.deferred.promise},setResponseTimeout:function(){!1!==this.timeout&&(this._timer=setTimeout(this.onTimeout,this.timeout||2E3))},clearResponseTimeout:function(){clearTimeout(this._timer)},getTransfer:function(){return this.transfer||
this.event&&this.event.ports},onMessage:function(a){if(a.data.response&&a.data.id===this.id&&!this.cancelled)this.onResponse(a)},onTimeout:function(){e("response timeout",this.type);this.silentTimeout||this.deferred.reject(n(4));this.teardown()},listen:function(a){e("add response listener",a);a=l(a);a.addListener(this.onMessage,this.listen);this.listeners.push(a);return this},unlisten:function(){var a=this;e("remove response listeners");this.listeners.forEach(function(e){return e.removeListener(a.onMessage)});
this.listeners=[]},cancel:function(){this.teardown();this.cancelled=!0;this.emit("cancel")},teardown:function(){this.clearResponseTimeout();this.unlisten()},respond:function(a){function b(a){e("resolve",a);d({type:"resolve",value:a})}function c(a){a:switch(a&&a.constructor.name){case "DOMException":case "Error":a={message:a.message};break a;case "DOMError":a={message:a.message,name:a.name};break a}e("reject",a);d({type:"reject",value:a})}function d(a){k.response=a;k.sourcePort.postMessage({id:k.id,
response:a},k.transfer);e("responded with:",a)}e("respond",a,this.id);if(this.hasResponded)throw n(2);if(this.sourcePort&&!this.noRespond){this.hasResponded=!0;var k=this;this.error&&c(this.error);Promise.resolve(a).then(b,c).catch(c)}},forward:function(a){var b=this;e("forward");return this.set("silentTimeout",!0).send(a).then(function(a){return b.respond(a.value)})},onResponse:function(a){e("on response",a.data);var b=a.data.response,c="reject"==b.type?b.value:b;b.event=a;this.response=b;this.teardown();
this.deferred[this.response.type](c);this.emit("response",b)}};g(c.prototype);m.prototype={listen:function(a){e("listen");a=l(a||self,{receiver:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.listen),this.ports.add(a),this},unlisten:function(){var a=this;e("unlisten");this.ports.forEach(function(b){return b.removeListener(a.onMessage)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.isRecipient(a.data.recipient)&&(e("receiver on message",a.data),a=new c(a),this.emit("message",
a),!a.defaultPrevented))try{this.emit(a.type,a)}catch(b){throw a.error=b,a.respond(),b;}},isRecipient:function(a){return a==this.name||"*"==a||"*"==this.name},destroy:function(){this.unlisten();delete this.name;return this}};g(m.prototype)},{"../emitter":3,"../utils":7,"./port-adaptors":5}],5:[function(d,f,h){function c(b){this.target=b}function m(b,a,c){b.addEventListener(a,c)}function n(b,a,c){a={data:a,source:self};c&&(a.ports=c);b.dispatchEvent(new MessageEvent("message",a))}var l=d("../utils").deferred;
f.exports=function(e,a){if(!e)throw Error({1:"target is undefined"}[1]);if(e&&"undefined"!==typeof e.addListener)return e;var d=b[e.constructor.name];return d?d(e,a):new c(e,a)};var g=c.prototype={constructor:c,addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,a){this.target.postMessage(b,a)}},b={HTMLIFrameElement:function(b){var a=k(b);return{addListener:function(a){window.addEventListener("message",
a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(c,d){a.then(function(){return n(b.contentWindow,c,d)})}}},BroadcastChannel:function(b,a){function c(){var a=l();b.postMessage("ready?");m(b,"message",function q(c){"ready"==c.data&&(b.removeEventListener("message",q),a.resolve())});return a.promise}var d=a&&a.receiver,k=a&&a.ready,k=k||d?Promise.resolve():c();d&&(b.postMessage("ready"),m(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));
return{target:b,addListener:g.addListener,removeListener:g.removeListener,postMessage:function(a,c){k.then(function(){return b.postMessage(a,c)})}}},Window:function(b,a){var c=a&&a.ready||b===parent||b===self,c=c?Promise.resolve():k(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,d){c.then(function(){return n(b,a,d)})}}},SharedWorker:function(b){b.port.start();return new c(b.port)},SharedWorkerGlobalScope:function(){var b=
[];return{postMessage:function(){},addListener:function(a,c){this.onconnect=function(a){a=a.ports[0];b.push(a);a.start();c(a)};self.addEventListener("connect",this.onconnect)},removeListener:function(a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();b.removeEventListener("message",a)})}}}},k=function(){if("undefined"!=typeof window){var b=window.opener||window.parent,a=new WeakSet;b!=self&&("loading"===document.readyState?m(window,"DOMContentLoaded",function p(){window.removeEventListener("DOMContentLoaded",
p);n(b,"load")}):n(b,"load"));m(self,"message",function(b){return"load"==b.data&&a.add(b.source)});return function(b){var c=b.contentWindow||b;if(a.has(c)||c==window.parent)return Promise.resolve();var e=l();m(window,"message",function q(a){"load"==a.data&&a.source==c&&(window.removeEventListener("message",q),e.resolve())});return e.promise}}}()},{"../utils":7}],6:[function(d,f,h){function c(b){if(!(this instanceof c))return new c(b);l.Receiver.call(this,b);this.clients={};this.methods={};this.on("_disconnect",
this.onDisconnect.bind(this)).on("_connect",this.onConnect.bind(this)).on("_method",this.onMethod.bind(this)).on("_off",this.onOff.bind(this)).on("_on",this.onOn.bind(this));this.destroy=this.destroy.bind(this);g("initialized",b)}function m(b){var c=[].slice.call(arguments,1);return Error({4:'method "'+c[0]+"\" doesn't exist"}[b])}var n=d("./utils").uuid,l=d("./message");d=l.Receiver;f.exports=c;var g={0:function(){},1:function(b){return performance.mark("["+self.constructor.name+"][Service] - "+
b)},2:function(b,c){for(var e=[],a=1;a<arguments.length;++a)e[a-1]=arguments[a];console.log.apply(console,[].concat(["[Service]"+("["+self.constructor.name+"]["+location.pathname+"]")+' - "'+b+'"'],$jscomp.arrayFromIterable(e)))}}[0];c.prototype=Object.create(d.prototype);c.prototype.inWindow="Window"===constructor.name;c.prototype.method=function(b,c){this.methods[b]=c;return this};c.prototype.broadcast=function(b,c,e){var a=this;g("broadcast",b,c,e);this.eachClient(function(d){if(!e||~e.indexOf(d.id))g("broadcasting to",
d.id),a.push(b,c,d.id,{noRespond:!0})});return this};c.prototype.push=function(b,c,e,a){a=a&&a.noRespond;var d=this.getClient(e);return l("_push").set({recipient:e,noRespond:a,data:{type:b,data:c}}).send(d.port)};c.prototype.eachClient=function(b){for(var c in this.clients)b(this.clients[c])};c.prototype.getClient=function(b){return this.clients[b]};c.prototype.onConnect=function(b){g("connection attempt",b.data,this.name);var c=b.data,d=c.clientId;d&&c.service===this.name&&!this.clients[d]&&(this.emit("before-connect",
b),b.defaultPrevented||(this.upgradeChannel(b),this.addClient(d,b.sourcePort),b.respond(),this.emit("connected",d),g("connected",d)))};c.prototype.upgradeChannel=function(b){if(!this.inWindow||"Window"!==b.data.originEnv){var c=b.event.ports;if(c=c&&c[0])b.setSourcePort(c),this.listen(c),c.start();g("channel upgraded")}};c.prototype.onDisconnect=function(b){var c=this.clients[b.data];c&&(this.emit("before-disconnect",b),b.defaultPrevented||(this.removeClient(c.id),b.respond(),this.emit("disconnected",
c.id),g("disconnected",c.id)))};c.prototype.onMethod=function(b){g("on method",b.data);this.emit("before-method",b);if(!b.defaultPrevented){var c=b.data,d=c.name,a=this.methods[d],f;if(!a)throw m(4,d);try{f=a.apply(this,c.args)}catch(h){b.error=h}b.respond(f)}};c.prototype.onOn=function(b){g("on on",b.data);this.emit("on",b.data)};c.prototype.onOff=function(b){g("on off");this.emit("off",b.data)};c.prototype.addClient=function(b,c){this.clients[b]={id:b,port:c}};c.prototype.removeClient=function(b){delete this.clients[b]};
c.prototype.plugin=function(b){b(this,{uuid:n});return this};c.prototype.disconnect=function(b){this.removeClient(b.id);l("disconnect").set({recipient:b.id,noRespond:!0}).send(b.port)};c.prototype.destroy=function(){delete this.clients;this.unlisten();this.off()};f=c.prototype;f.broadcast=f.broadcast;f.destroy=f.destroy;f.method=f.method;f.plugin=f.plugin},{"./message":4,"./utils":7}],7:[function(d,f,h){h.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var d=
16*Math.random()|0;return("x"==c?d:d&3|8).toString(16)})};h.deferred=function(){var c={};c.promise=new Promise(function(d,f){c.resolve=d;c.reject=f});return c}},{}]},{},[1]);
